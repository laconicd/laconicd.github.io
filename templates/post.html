{% extends "base.html" %}

{% block content %}
<style>
  /* 1. 공유 섹션 전체 컨테이너 */
  .app-post .post-share-section {
    margin: 6rem auto 4rem !important;
    padding: 4rem 2rem !important;
    background: var(--color-base-100) !important;
    border-radius: 4rem !important;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    gap: 3.5rem !important;
    text-align: center !important;
    border: 1px solid oklch(from var(--color-base-content) l c h / 0.08) !important;
    box-shadow: 0 40px 100px -20px oklch(0 0 0 / 0.04) !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
    position: relative !important;
  }

  /* 2. 헤더 텍스트 */
  .post-share-section .share-header .sub {
    display: block !important;
    font-size: 0.75rem !important;
    font-weight: 900 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5em !important;
    color: oklch(from var(--color-base-content) l c h / 0.3) !important;
    margin-bottom: 1.5rem !important;
  }
  .post-share-section .share-header .main {
    font-size: clamp(1.8rem, 5vw, 2.5rem) !important;
    font-weight: 900 !important;
    letter-spacing: -0.05em !important;
    color: var(--color-base-content) !important;
    margin: 0 !important;
    line-height: 1.1 !important;
  }

  /* 3. URL 복사 카드 (가로 배치 고정) */
  .post-share-section .copy-card {
    width: 100% !important;
    max-width: 38rem !important;
    background: var(--color-base-200) !important;
    border: 1px solid oklch(from var(--color-base-content) l c h / 0.05) !important;
    border-radius: 100px !important;
    padding: 0.6rem 0.6rem 0.6rem 2rem !important;
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: 1rem !important;
    transition: all 0.4s ease !important;
    box-sizing: border-box !important;
  }

  @media (max-width: 768px) {
    .post-share-section .copy-card {
      flex-direction: column !important;
      border-radius: 2.5rem !important;
      padding: 1.5rem !important;
    }
  }

  .copy-card .url-display {
    flex: 1 !important;
    display: flex !important;
    align-items: center !important;
    gap: 1rem !important;
    min-width: 0 !important;
    width: 100% !important; /* Ensure full width in flex-column */
    color: var(--color-base-content) !important;
    overflow: hidden !important; /* Contain the text */
  }
  .copy-card .url-display svg {
    opacity: 0.3 !important;
    flex-shrink: 0 !important;
  }
  .copy-card .url-text {
    font-size: 0.95rem !important;
    font-weight: 600 !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    flex: 1 !important;
    min-width: 0 !important;
  }

  /* 4. 복사 버튼 (검정 알약) */
  .copy-card .copy-btn {
    background: var(--color-base-content) !important;
    color: var(--color-base-100) !important;
    border: none !important;
    padding: 1rem 2.5rem !important;
    border-radius: 100px !important;
    font-size: 0.85rem !important;
    font-weight: 900 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.1em !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    white-space: nowrap !important;
  }
  .copy-card .copy-btn:hover {
    transform: scale(1.03) !important;
    filter: brightness(1.2) !important;
  }
  .copy-card .copy-btn.copied {
    background: #10b981 !important;
    color: white !important;
  }

  /* 5. 소셜 아이콘 (가로 배치 고정) */
  .post-share-section .social-actions {
    display: flex !important;
    flex-direction: row !important;
    gap: 1.5rem !important;
    justify-content: center !important;
  }
  .social-actions .action-item {
    width: 4rem !important;
    height: 4rem !important;
    background: var(--color-base-200) !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: var(--color-base-content) !important;
    text-decoration: none !important;
    transition: all 0.4s ease !important;
    border: 1px solid transparent !important;
  }
  .social-actions .action-item:hover {
    background: var(--color-base-content) !important;
    color: var(--color-base-100) !important;
    transform: translateY(-8px) !important;
  }
  .social-actions .action-item svg {
    width: 1.5rem !important;
    height: 1.5rem !important;
    opacity: 0.6 !important;
  }
  .social-actions .action-item:hover svg {
    opacity: 1 !important;
  }
</style>

<style>
  @scope(.app-post) {
    :scope {
      max-width: 55rem;
      margin: 0 auto;
      padding: 4rem 1.5rem 10rem;
      display: grid;
      grid-template-columns: minmax(0, 1fr); /* Grid 아이템이 너비를 초과하지 않도록 보장 */
      gap: 4rem;
      animation: fadeIn 1.2s var(--ease-standard);
      
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      width: 100%;
      box-sizing: border-box;

      @media (width < 48rem) {
        padding: 2rem 1.25rem 5rem;
        gap: 2.5rem;
      }
    }

    /* Header Section */
    & .post-header {
      text-align: center;
      display: grid;
      justify-items: center;
      gap: 2rem;
      animation: fadeInDown 0.8s var(--ease-standard);
      min-width: 0;

      @media (width < 48rem) {
        gap: 1.5rem;
      }

      & .post-meta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.75rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: var(--color-primary);
        
        & .separator { opacity: 0.2; }
        & time { opacity: 0.6; }
      }

      & h1 {
        font-size: clamp(2.2rem, 8vw, 5rem);
        font-weight: 900;
        line-height: 1.05;
        letter-spacing: -0.05em;
        background: linear-gradient(to bottom, var(--color-base-content) 60%, oklch(from var(--color-base-content) l c h / 0.3));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin: 0;
        word-break: keep-all;
        overflow-wrap: break-word;
      }

      & .post-author {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        text-align: left;

        & .author-avatar {
          width: clamp(3rem, 10vw, 3.5rem);
          height: clamp(3rem, 10vw, 3.5rem);
          border-radius: 50%;
          overflow: hidden;
          background: var(--color-base-300);
          border: 2px solid oklch(from var(--color-base-content) l c h / 0.1);
          box-shadow: var(--shadow-2);
          flex-shrink: 0;
          
          & img {
            width: 100%;
            height: 100%;
            object-fit: cover;
          }
        }
        
        & .author-info {
          display: grid;
          & .name {
            font-size: 0.85rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
          }
          & .role {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            opacity: 0.4;
          }
        }
      }
    }

    /* Featured Image */
    & .post-visual {
      position: relative;
      border-radius: 2.5rem;
      overflow: hidden;
      aspect-ratio: 16 / 9;
      box-shadow: var(--shadow-4);
      border: 1px solid oklch(from var(--color-base-content) l c h / 0.05);
      animation: fadeInUp 1s var(--ease-standard) 0.2s both;
      width: 100%;

      @media (width < 48rem) {
        border-radius: 1.5rem;
      }

      & img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
    }

    /* Content Area */
    & .post-content {
      font-size: clamp(1.05rem, 2vw, 1.2rem);
      line-height: 1.7;
      color: oklch(from var(--color-base-content) l c h / 0.8);
      animation: fadeInUp 1s var(--ease-standard) 0.4s both;
      min-width: 0;
      width: 100%;

      & h2, & h3, & h4 {
        color: var(--color-base-content);
        font-weight: 900;
        letter-spacing: -0.03em;
        margin-top: clamp(2rem, 5vw, 3.5rem);
        margin-bottom: 1.25rem;
        overflow-wrap: break-word;
      }

      & h2 { font-size: clamp(1.75rem, 5vw, 2.25rem); line-height: 1.1; }
      & h3 { font-size: clamp(1.4rem, 4vw, 1.75rem); }

      & p { margin-bottom: 1.5rem; overflow-wrap: break-word; }

      & a {
        color: var(--color-primary);
        text-decoration: none;
        font-weight: 700;
        border-bottom: 2px solid oklch(from var(--color-primary) l c h / 0.2);
        transition: all 0.2s var(--ease-standard);
        &:hover {
          background: oklch(from var(--color-primary) l c h / 0.1);
          border-bottom-color: var(--color-primary);
        }
      }

      & img {
        max-width: 100%;
        height: auto;
        border-radius: 2rem;
        margin: clamp(1.5rem, 5vw, 3rem) 0;
        box-shadow: var(--shadow-3);
        @media (width < 48rem) { border-radius: 1rem; }
      }

      & code:not(pre code) {
        background: var(--color-base-200);
        padding: 0.2rem 0.5rem;
        border-radius: 0.5rem;
        font-size: 0.9em;
        font-weight: 600;
        word-break: break-all;
      }

      & pre {
        background: var(--color-base-300) !important;
        padding: clamp(1.25rem, 4vw, 2rem);
        border-radius: 1.5rem;
        margin: 2rem 0;
        overflow-x: auto; /* 내용이 넘치면 개별 스크롤 발생 */
        font-size: 0.85em;
        max-width: 100%;
        width: 100%;
        display: block;
        box-sizing: border-box;
        white-space: pre; /* 줄바꿈 없이 스크롤 유지 */
        -webkit-overflow-scrolling: touch;
        @media (width < 48rem) { border-radius: 1rem; }
      }

      & blockquote {
        border-left: 4px solid var(--color-primary);
        padding-left: clamp(1rem, 4vw, 2rem);
        font-style: italic;
        margin: clamp(1.5rem, 5vw, 3rem) 0;
        color: oklch(from var(--color-base-content) l c h / 0.6);
      }
    }

    /* Footer Section */
    & .post-footer {
      margin-top: 4rem;
      padding-top: 4rem;
      border-top: 1px solid oklch(from var(--color-base-content) l c h / 0.1);
      display: grid;
      gap: clamp(2.5rem, 6vw, 4rem);
      animation: fadeIn 1.5s var(--ease-standard) 0.6s both;
      min-width: 0;

      @media (width < 48rem) {
        margin-top: 2rem;
        padding-top: 2rem;
      }

      & .post-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;

        & a {
          font-size: 0.85rem;
          font-weight: 800;
          color: var(--color-base-content);
          text-decoration: none;
          background: oklch(from var(--color-base-content) l c h / 0.05);
          padding: 0.5rem 1rem;
          border-radius: 1rem;
          opacity: 0.6;
          transition: all 0.2s;
          &:hover {
            opacity: 1;
            background: oklch(from var(--color-base-content) l c h / 0.1);
            transform: translateY(-2px);
          }
        }
      }

      & .post-navigation {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;

        @media (width < 48rem) {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        & .nav-card {
          display: flex;
          flex-direction: column;
          padding: clamp(1.5rem, 4vw, 2.5rem);
          background: var(--color-base-200);
          border-radius: 2rem;
          transition: all 0.4s var(--ease-standard);
          text-decoration: none;
          color: inherit;
          border: 1px solid transparent;
          min-width: 0;

          @media (width < 48rem) { border-radius: 1.25rem; }

          &:hover {
            transform: translateY(-4px);
            background: var(--color-base-300);
            border-color: oklch(from var(--color-base-content) l c h / 0.1);
            & .nav-label { color: var(--color-primary); }
          }

          &.next { text-align: right; }

          & .nav-label {
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            opacity: 0.4;
            margin-bottom: 0.75rem;
            transition: color 0.3s var(--ease-standard);
          }

          & .nav-title {
            font-size: clamp(1rem, 3vw, 1.1rem);
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
        }
      }
    }

    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  }
</style>

<article class="app-post">
  <!-- Post Header -->
  <header class="post-header">
    <div class="post-meta">
      {% if page.taxonomies.categories %}
        {% for cat in page.taxonomies.categories %}
          <span>{{ cat }}</span>
        {% endfor %}
        <span class="separator">•</span>
      {% endif %}
      <time datetime="{{ page.date }}">{{ page.date | date(format="%B %d, %Y") }}</time>
    </div>

    <h1>{{ page.title }}</h1>

    <div class="post-author">
      <div class="author-avatar">
        <img src="{{ get_url(path=config.extra.author_avatar) | safe }}" alt="{{ config.extra.author_name }}" />
      </div>
      <div class="author-info">
        <span class="name">{{ config.extra.author_name }}</span>
        <span class="role">{{ config.extra.author_role }}</span>
      </div>
    </div>
  </header>

  <!-- Featured Image -->
  <div class="post-visual">
    {% if page.extra.image %}
      {# relative_path를 활용하여 정확한 폴더 경로 추출 #}
      {% set path_parts = page.relative_path | split(pat="/") %}
      {% set dir_path = path_parts | slice(end=-1) | join(sep="/") %}
      {% set image_path = "static/media/" ~ dir_path ~ "/" ~ page.extra.image %}
      {% set resized = resize_image(path=image_path, width=1600, height=900, op="fill", format="webp") %}
      <img src="{{ resized.url }}" alt="{{ page.title }}" loading="eager" />
    {% else %}
      <img src="{{ get_url(path='images/default-post.jpg') }}" alt="{{ page.title }}" />
    {% endif %}
  </div>

  <!-- Content -->
  <div class="post-content">
    {{ page.content | safe }}
  </div>

  <!-- Share Section -->
  <section class="post-share-section">
    <div class="share-header">
      <span class="sub">Sharing is Caring</span>
      <h2 class="main">Enjoyed this post?</h2>
    </div>

    <div class="copy-card">
      <div class="url-display">
        {{ icons::link(size=5) }}
        <span class="url-text">{{ current_url | safe }}</span>
      </div>
      <button id="post-share-btn" class="copy-btn">
        <span class="label">Copy Link</span>
      </button>
    </div>

    <div class="social-actions">
      <a href="https://twitter.com/intent/tweet?url={{ current_url | safe }}&text={{ page.title }}" 
         target="_blank" rel="noopener noreferrer" class="action-item" title="Share on X">
        {{ icons::x(size=6) }}
      </a>

      <a href="{{ get_url(path='@/posts/_index.md') }}" class="action-item" title="Back to Archive">
        {{ icons::post(size=6) }}
      </a>

      <a href="/" class="action-item" title="Go Home">
        {{ icons::home(size=6) }}
      </a>
    </div>
  </section>

  <!-- Footer -->
  <footer class="post-footer">
    {% if page.taxonomies.tags %}
      <div class="post-tags">
        {% for tag in page.taxonomies.tags %}
          <a href="{{ get_taxonomy_url(kind='tags', name=tag) }}">
            #{{ tag }}
          </a>
        {% endfor %}
      </div>
    {% endif %}

    <nav class="post-navigation">
      {% if page.lower %}
        <a href="{{ page.lower.path }}" class="nav-card prev">
          <span class="nav-label">Previous Post</span>
          <span class="nav-title">{{ page.lower.title }}</span>
        </a>
      {% endif %}

      {% if page.higher %}
        <a href="{{ page.higher.path }}" class="nav-card next">
          <span class="nav-label">Next Post</span>
          <span class="nav-title">{{ page.higher.title }}</span>
        </a>
      {% endif %}
    </nav>
  </footer>

  <script>
    (function() {
      const shareBtn = document.getElementById('post-share-btn');
      const shareModal = document.getElementById('share_modal');
      if (shareBtn) {
        shareBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(window.location.href);
            
            const label = shareBtn.querySelector('.label');
            const originalText = label.innerText;
            shareBtn.classList.add('copied');
            label.innerText = 'Copied!';
            
            if (shareModal && shareModal.showPopover) shareModal.showPopover();

            setTimeout(() => {
              shareBtn.classList.remove('copied');
              label.innerText = originalText;
            }, 2000);
          } catch (err) { 
            console.error(err);
          }
        };
      }
    })();
  </script>
</article>
{% endblock content %}
