{% import "macros/icons.html" as icons %}

<style>
  @scope(.app-speed-dial) {
    :scope {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      z-index: 60;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 메인 플로팅 버튼 */
    & .fab-trigger {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background-color: var(--color-base-content);
      color: var(--color-base-100);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      box-shadow: var(--shadow-xl);
      z-index: 2;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      
      &:hover { transform: scale(1.1); }
      &:active { transform: scale(0.95); }

      & .icon-close { display: none; }
    }

    &.open .fab-trigger {
      & .icon-main { display: none; }
      & .icon-close { display: flex; }
    }

    /* 개별 아이템 공통 스타일 */
    & .dial-item {
      position: absolute;
      width: 3.5rem;
      height: 3.5rem;
      border-radius: 50%;
      background-color: var(--color-base-100);
      color: var(--color-base-content);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid oklch(from var(--color-base-content) l c h / 0.05);
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
      text-decoration: none;
      
      /* 기본 상태: 중앙에 숨김 */
      opacity: 0;
      pointer-events: none;
      --tx: 0px;
      --ty: 0px;
      transform: translate(0, 0) scale(0);
      transition: 
        opacity 0.3s ease,
        transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 1;
    }

    /* 열림 상태: 각자의 좌표로 이동 */
    &.open .dial-item {
      opacity: 1;
      pointer-events: auto;
      transform: translate(var(--tx), var(--ty)) scale(1);

      /* 호버 시 좌표 유지하며 크기만 확대 */
      &:hover {
        background-color: var(--color-base-200);
        transform: translate(var(--tx), var(--ty)) scale(1.1);
        transition: transform 0.2s ease;
      }
    }

    /* 좌표 설정 (부채꼴 레이아웃) */
    & .dial-item:nth-child(1) { --tx: -5.5rem; --ty: 0; transition-delay: 0.05s; }
    & .dial-item:nth-child(2) { --tx: -4.8rem; --ty: -4.8rem; transition-delay: 0.1s; }
    & .dial-item:nth-child(3) { --tx: -2.2rem; --ty: -8.5rem; transition-delay: 0.15s; }
    & .dial-item:nth-child(4) { --tx: 1.8rem; --ty: -10.5rem; transition-delay: 0.2s; }
  }
</style>

<div class="app-speed-dial">
  <div class="dial-items">
    <button id="speed-dial-top" class="dial-item" aria-label="Scroll to Top">{{ icons::top(size=5) }}</button>
    <button id="speed-dial-search" class="dial-item" aria-label="Search">{{ icons::search(size=5) }}</button>
    <button id="speed-dial-share" class="dial-item" aria-label="Share">{{ icons::share(size=5) }}</button>
    <a href="{{ get_url(path='rss.xml') }}" target="_blank" class="dial-item" aria-label="RSS Feed">{{ icons::rss(size=5) }}</a>
  </div>

  <button id="speed-dial-trigger" class="fab-trigger" aria-label="Toggle Menu">
    <span class="icon-main">{{ icons::lightning(size=6) }}</span>
    <span class="icon-close">{{ icons::minus(size=6) }}</span>
  </button>
</div>

<script>
  (function() {
    const setupDial = () => {
      const dial = document.querySelector('.app-speed-dial');
      const trigger = document.getElementById('speed-dial-trigger');
      const topBtn = document.getElementById('speed-dial-top');
      const searchBtn = document.getElementById('speed-dial-search');
      const shareBtn = document.getElementById('speed-dial-share');
      const shareModal = document.getElementById('share_modal');
      const searchModal = document.getElementById('search_modal');

      if (!dial || !trigger) return;

      trigger.onclick = (e) => {
        e.stopPropagation();
        dial.classList.toggle('open');
      };

      document.addEventListener('click', (e) => {
        if (!dial.contains(e.target)) dial.classList.remove('open');
      });

      if (topBtn) {
        topBtn.onclick = () => {
          window.scrollTo({top: 0, behavior: 'smooth'});
          dial.classList.remove('open');
        };
      }

      if (searchBtn) {
        searchBtn.onclick = () => {
          if (searchModal?.showPopover) {
            searchModal.showPopover();
          }
          dial.classList.remove('open');
        };
      }

      if (shareBtn && shareModal) {
        shareBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(window.location.href);
            if (shareModal.showPopover) shareModal.showPopover();
          } catch (err) { console.error(err); }
          dial.classList.remove('open');
        };
      }
    };
    setupDial();
    window.addEventListener('page:updated', setupDial);
  })();
</script>
