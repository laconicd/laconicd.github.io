{% import "macros/icons.html" as icons %}

<div class="app-speed-dial">
  <div class="dial-items">
    <button id="speed-dial-top" class="dial-item" aria-label="Scroll to Top">{{ icons::top(size=5) }}</button>
    <button id="speed-dial-search" class="dial-item" aria-label="Search">{{ icons::search(size=5) }}</button>
    <label class="dial-item theme-toggle" aria-label="Toggle Theme">
      <input type="checkbox" class="theme-controller" value="dim" />
      <span class="sun-icon">{{ icons::sun(size=5) }}</span>
      <span class="moon-icon">{{ icons::moon(size=5) }}</span>
    </label>
    <button id="speed-dial-random" class="dial-item" aria-label="Random Post">{{ icons::shuffle(size=5) }}</button>
  </div>

  <button id="speed-dial-trigger" class="fab-trigger" aria-label="Toggle Menu">
    <span class="icon-main">{{ icons::lightning(size=6) }}</span>
    <span class="icon-close">{{ icons::minus(size=6) }}</span>
  </button>
</div>

<script>
  (function() {
    const posts = [
      {% set section = get_section(path="posts/_index.md") %}
      {% for page in section.pages %}
        "{{ page.permalink | safe }}",
      {% endfor %}
    ];

    const setupDial = () => {
      const dial = document.querySelector('.app-speed-dial');
      const trigger = document.getElementById('speed-dial-trigger');
      const topBtn = document.getElementById('speed-dial-top');
      const searchBtn = document.getElementById('speed-dial-search');
      const randomBtn = document.getElementById('speed-dial-random');
      const searchModal = document.getElementById('search_modal');

      if (!dial || !trigger) return;

      const currentTheme = document.documentElement.getAttribute('data-theme');
      const isDark = currentTheme === 'dim';
      dial.querySelectorAll('.theme-controller').forEach(el => {
        el.checked = isDark;
      });

      trigger.onclick = (e) => {
        e.stopPropagation();
        dial.classList.toggle('open');
      };

      document.addEventListener('click', (e) => {
        if (!dial.contains(e.target)) dial.classList.remove('open');
      });

      if (topBtn) {
        topBtn.onclick = () => {
          window.scrollTo({top: 0, behavior: 'smooth'});
          dial.classList.remove('open');
        };
      }

      if (searchBtn) {
        searchBtn.onclick = () => {
          if (searchModal?.showPopover) {
            searchModal.showPopover();
          }
          dial.classList.remove('open');
        };
      }

      if (randomBtn && posts.length > 0) {
        randomBtn.onclick = () => {
          const currentPath = window.location.href;
          const otherPosts = posts.filter(p => p !== currentPath);
          const targetPosts = otherPosts.length > 0 ? otherPosts : posts;
          const randomPost = targetPosts[Math.floor(Math.random() * targetPosts.length)];
          window.location.href = randomPost;
        };
      }
    };
    setupDial();
    window.addEventListener('page:updated', setupDial);
  })();
</script>
