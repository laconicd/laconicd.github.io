{% macro get_url(page, width, height, op="fill", format="webp") %}
  {% if page.extra.image %}
    {% set path_parts = page.relative_path | split(pat="/") %}
    {% set dir_path = path_parts | slice(end=-1) | join(sep="/") %}
    {% set image_path = "static/media/" ~ dir_path ~ "/" ~ page.extra.image %}
  {% else %}
    {# Deterministic random choice based on title length #}
    {% set random_index = page.title | length % 29 + 1 %}
    {% set image_path = "static/images/random/" ~ random_index ~ ".jpg" %}
  {% endif %}
  
  {% set resized = resize_image(path=image_path, width=width, height=height, op=op, format=format) %}
  {{ resized.url | safe }}
{% endmacro %}

{% macro img(page, width, height, alt="", class="", priority="auto", sizes="100vw") %}
  {% set src = get_url(page=page, width=width, height=height) %}
  {% set loading = "lazy" %}
  {% set decoding = "async" %}
  {% set fetchpriority = "auto" %}

  {% if priority == "high" %}
    {% set loading = "eager" %}
    {% set fetchpriority = "high" %}
  {% endif %}

  <img 
    src="{{ src }}" 
    alt="{{ alt }}" 
    class="{{ class }}"
    width="{{ width }}"
    height="{{ height }}"
    loading="{{ loading }}"
    decoding="{{ decoding }}"
    fetchpriority="{{ fetchpriority }}"
  />
{% endmacro %}
