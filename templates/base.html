{% import "macros/icons.html" as icons %}

<!DOCTYPE html>
<html lang="en" data-theme="lofi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  {% include "partials/init-feat.html" %}

  <script>
    (function () {
      const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dim' : 'lofi');
      document.documentElement.setAttribute('data-theme', theme);
      const link = document.createElement('link');
      link.id = 'syntax-theme';
      link.rel = 'stylesheet';
      const darkUrl = "{{ get_url(path='giallo-dark.css') | safe }}";
      const lightUrl = "{{ get_url(path='giallo-light.css') | safe }}";
      link.href = theme === 'dim' ? darkUrl : lightUrl;
      document.head.appendChild(link);

      window.__SYNTAX_THEME_URLS__ = {
        dim: darkUrl,
        lofi: lightUrl
      };
    })();
  </script>

  {% set title = config.title %}
  {% set description = config.description %}
  {% set og_image = get_url(path=config.extra.default_image) %}

  {% if page %}
  {% set title = page.title %}
  {% set description = page.summary | default(value=page.description) | default(value=description) %}
  {% if page.extra.image %}
  {% set path_parts = page.relative_path | split(pat="/") %}
  {% set dir_path = path_parts | slice(end=-1) | join(sep="/") %}
  {% set image_path = "static/media/" ~ dir_path ~ "/" ~ page.extra.image %}
  {% set og_image_processed = resize_image(path=image_path, width=1200, height=630, op="fill") %}
  {% set og_image = og_image_processed.url %}
  {% endif %}
  {% elif section %}
  {% set title = section.title | default(value=title) %}
  {% set description = section.description | default(value=description) %}
  {% if section.extra.image %}
  {% set og_image = get_url(path=section.extra.image) %}
  {% endif %}
  {% endif %}

  {% set description = description | striptags | truncate(length=160) %}

  <meta name="description" content="{{ description }}">
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ current_url | safe }}">
  <meta property="og:title" content="{{ title }}">
  <meta property="og:description" content="{{ description }}">
  <meta property="og:image" content="{{ og_image | safe }}">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="{{ current_url | safe }}">
  <meta property="twitter:title" content="{{ title }}">
  <meta property="twitter:description" content="{{ description }}">
  <meta property="twitter:image" content="{{ og_image | safe }}">

  <link rel="canonical" href="{{ current_url | safe }}">
  <link rel="stylesheet" href="{{ get_url(path='styles/main.css', cachebust=true) | safe }}">
  <link rel="alternate" type="application/atom+xml" title="Atom Feed"
    href="{{ get_url(path='atom.xml', trailing_slash=false) }}">
  <link rel="alternate" type="application/rss+xml" title="RSS Feed"
    href="{{ get_url(path='rss.xml', trailing_slash=false) }}">

  <title>{{ title }}</title>
</head>

<body>
  <div class="app-shell">
    <header>{% include "partials/navbar.html" %}</header>
    <main>{% block content %} {% endblock content %}</main>
    <footer>{% include "partials/footer.html" %}</footer>
  </div>

  <div class="widgets">
    {% include "partials/search-modal.html" %}
    {% include "partials/share-modal.html" %}
    {% include "partials/speed-dial.html" %}
  </div>

  <script>
    const syncThemeControllers = () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const isDark = currentTheme === 'dim';
      document.querySelectorAll('.theme-controller').forEach(el => {
        el.checked = isDark;
      });
    };

    document.addEventListener('DOMContentLoaded', syncThemeControllers);
    window.addEventListener('page:updated', syncThemeControllers);

    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('theme-controller')) {
        const isDark = e.target.checked;
        const newTheme = isDark ? 'dim' : 'lofi';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);

        const link = document.getElementById('syntax-theme');
        if (link && window.__SYNTAX_THEME_URLS__) {
          link.href = window.__SYNTAX_THEME_URLS__[newTheme];
        }

        document.querySelectorAll('.theme-controller').forEach(el => {
          if (el !== e.target) el.checked = isDark;
        });
      }
    });
  </script>
</body>

</html>
